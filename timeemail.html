<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>A6C2--ChronoMail</title>
  <style>
    :root{
      --sidebar-width:220px;
      --accent:#00e5ff;
      --bg-1:#071129;
      --bg-2:#00131a;
      --card:#071a26;
      --muted:#9fb4c8;
      --glass: rgba(255,255,255,0.03);
    }
    /* Techy animated background */
    html,body{height:100%;}
    body{
      margin:0; font-family:Inter, ui-sans-serif, system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial;
      color:#e6f7ff; background: linear-gradient(180deg,var(--bg-1) 0%, #021428 50%, var(--bg-2) 100%);
      overflow:hidden;
    }
    .bg-canvas{
      position:fixed; inset:0; z-index:0; pointer-events:none; mix-blend-mode:screen;
      background-image:
        radial-gradient(circle at 10% 20%, rgba(0,230,255,0.06), transparent 8%),
        radial-gradient(circle at 90% 80%, rgba(0,230,255,0.04), transparent 12%),
        repeating-linear-gradient(45deg, rgba(0,0,0,0.03) 0 1px, transparent 1px 20px);
      animation: drift 18s linear infinite;
      filter:blur(18px);
    }
    @keyframes drift{from{transform:translateY(0) rotate(0);} to{transform:translateY(-30px) rotate(1deg);}}

    /* Main layout */
    .app{position:relative; display:flex; height:100vh; z-index:1}
    .sidebar{
      width:var(--sidebar-width); padding:22px 14px; box-sizing:border-box;
      border-right:1px solid rgba(255,255,255,0.04);
      background:linear-gradient(180deg, rgba(255,255,255,0.02), transparent);
      backdrop-filter: blur(6px);
    }
    .brand{display:flex; flex-direction:column; align-items:flex-start; gap:8px; margin-bottom:18px}
    .site-logo h1{
      font-size:40px; margin:0 0 6px 0; font-weight:900; letter-spacing:1.8px; line-height:1;
      /* techy gradient text */
      background: linear-gradient(90deg, var(--accent), #7b5dff 70%);
      -webkit-background-clip: text; background-clip: text; color: transparent;
      text-shadow: 0 10px 30px rgba(123,93,255,0.06), 0 4px 10px rgba(0,230,255,0.04);
      font-family: 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      text-transform:uppercase; display:block; transform-origin:left center;
    }
    .user-block{display:flex;align-items:center;gap:10px}
  .user-name{font-weight:700;color:var(--muted);font-size:12px}
    .brand h1{font-size:14px;margin:0; letter-spacing:0.4px}
    nav{margin-top:6px; display:flex; flex-direction:column; gap:8px}
    .nav-btn{
      display:flex; align-items:center; gap:12px; padding:10px 12px; border-radius:8px; cursor:pointer;
      color:var(--muted); text-decoration:none; border:1px solid transparent;
    }
    .nav-btn:hover{background:rgba(255,255,255,0.02); color:#dff8ff}
    .nav-btn.active{ background:linear-gradient(90deg, rgba(0,230,255,0.06), rgba(75,126,255,0.03)); color:var(--accent); box-shadow:0 6px 14px rgba(3,74,120,0.12); border-color:rgba(0,230,255,0.06)}
    .nav-btn svg{flex:0 0 20px; opacity:0.9}

    /* Content area */
    .main{
      flex:1; padding:28px; box-sizing:border-box; overflow:auto;
      -webkit-overflow-scrolling:touch;
    }
    .header{display:flex; align-items:center; justify-content:space-between; gap:16px}
    .page-title{font-size:20px; letter-spacing:0.2px}
    .card{
      background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
      border-radius:12px; padding:18px; margin-top:18px; box-shadow: 0 6px 20px rgba(2,10,15,0.4);
      border:1px solid rgba(255,255,255,0.03);
    }
    .emails{display:flex; flex-direction:column; gap:8px}
    .email{
      display:flex; align-items:flex-start; gap:12px; padding:12px; border-radius:10px; cursor:pointer;
      transition:transform .12s ease, background .12s ease; background:linear-gradient(180deg, rgba(255,255,255,0.01), transparent);
    }
    .email:hover{transform:translateY(-4px); background:linear-gradient(180deg, rgba(0,230,255,0.02), rgba(255,255,255,0.01));}
    .avatar{width:44px; height:44px; border-radius:10px; background:linear-gradient(135deg,#09344b,#005e78); display:flex; align-items:center; justify-content:center; color:#dff8ff; font-weight:600}
  .meta{flex:1}
  .meta .from{font-weight:600; color:#dff8ff}
  .meta .subject{color:var(--muted); font-size:13px}

    /* Inbox split: list on the left, detail on the right */
    .inbox-split{display:flex; gap:18px; /* fill most of the vertical space and leave bottom margin */
      height: calc(100vh - 260px); margin-bottom:24px}
    .inbox-list{width:360px; max-width:40%; height:100%; overflow:auto}
    .inbox-detail{flex:1; min-width:280px; height:100%; overflow:auto}
    .inbox-list.card{padding:12px}
    .inbox-detail.card{padding:18px}
    .email.selected{outline:2px solid rgba(0,230,255,0.08); background:linear-gradient(180deg, rgba(0,230,255,0.02), rgba(255,255,255,0.01));}
    .email:focus{outline:2px solid rgba(0,230,255,0.06)}

  /* Detail subject larger for emphasis */
  .detail-subject{font-size:18px;font-weight:800;color:var(--muted);margin-top:6px}

  /* Conversation thread styles */
  .conversation{margin-top:12px; display:flex; flex-direction:column; gap:8px}
  .conv-item{border-radius:8px; padding:10px; background:rgba(255,255,255,0.01); border:1px solid rgba(255,255,255,0.02)}
  .conv-header{display:flex; align-items:center; justify-content:space-between; gap:8px}
  .conv-header strong{font-weight:700}
  .conv-time{color:var(--muted); font-size:12px}
  .conv-toggle{
    background:transparent;border:none;color:var(--muted);cursor:pointer;
    font-size:18px; width:36px; height:36px; display:inline-flex; align-items:center; justify-content:center;
    padding:6px; border-radius:8px; transition:background .12s ease, color .12s ease;
    /* ensure the toggle sits above the safety badge so it's always clickable */
    position:relative; z-index:30;
  }
  .conv-toggle:hover{background:rgba(255,255,255,0.03); color:var(--accent)}
  .conv-body{margin-top:8px;color:var(--muted);line-height:1.4; max-height:0; overflow:hidden; transition:max-height .22s ease, padding .22s ease}
  .conv-item.expanded .conv-body{max-height:600px;padding-top:6px}

    /* Safety score circle in the detail pane */
    .inbox-detail{position:relative}
    .safety-score{
      position:absolute; bottom:14px; right:14px; width:110px; height:110px; border-radius:50%;
      display:flex; flex-direction:column; align-items:center; justify-content:center; text-align:center;
      color:#00161a; font-weight:800; box-shadow:0 8px 20px rgba(2,8,12,0.45); border:1px solid rgba(0,0,0,0.18);
      background:linear-gradient(180deg, rgba(255,255,255,0.95), rgba(255,255,255,0.9));
      backdrop-filter: blur(6px);
      padding:8px;
      /* make sure it doesn't block interactive controls visually — toggles will appear above */
      z-index:5;
    }
  .safety-score .label{font-size:11px;color:#000!important;font-weight:700;margin-bottom:4px}
  .safety-score .score-number{font-size:28px; line-height:1; color:#000!important}
  .safety-score.score-green{background:linear-gradient(180deg,#cafff7,#b8fff0)}
  .safety-score.score-yellow{background:linear-gradient(180deg,#fff8d1,#fff2b3)}
  .safety-score.score-red{background:linear-gradient(180deg,#ffd6d6,#ffb3b3)}

    /* page zones hidden by default */
    .zone{display:none}
    .zone.active{display:block}

    /* responsive */
    @media (max-width:720px){
      .sidebar{display:none}
      .app{padding:8px}
    }

    /* Main page info rows */
    .info-list{margin-top:12px; display:flex; flex-direction:column; gap:12px; max-width:720px}
    .info-row{display:flex;justify-content:space-between;align-items:center;padding:14px;border-radius:8px;background:rgba(255,255,255,0.02);border:1px solid rgba(255,255,255,0.02);width:100%;}
    .info-row + .info-row{margin-top:8px}
    .info-label{color:var(--muted)}
    .info-value{font-weight:700}
    /* small utility */
    .muted{color:var(--muted)}
    .btn{background:var(--accent); color:#01222b; padding:8px 12px; border-radius:8px; border:none; cursor:pointer}
  </style>
</head>
<body>
  <div class="bg-canvas" aria-hidden="true"></div>
  <div class="app" role="application">
    <aside class="sidebar" aria-label="Left navigation">
      <div class="brand">
        <div class="site-logo"><h1>ChronoMail</h1></div>

        <div class="user-block" aria-label="User">
          <div class="avatar">A</div>
          <div class="user-name">A6C2</div>
        </div>

        <div class="signature muted" style="font-size:12px">He said one day you will leave this world behind, so live a life you will remember!</div>
      </div>
      <nav aria-label="Mailbox folders">
        <button class="nav-btn activate" data-zone="sent" aria-pressed="true"><svg viewBox="0 0 24 24" width="20" height="20" fill="none"><path d="M22 2L11 13" stroke="currentColor" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round"/><path d="M22 2l-7 20-4-9-9-4 20-7z" stroke="currentColor" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round"/></svg>已发送邮箱</button>
        <button class="nav-btn" data-zone="junk" aria-pressed="false"><svg viewBox="0 0 24 24" width="20" height="20" fill="none"><path d="M3 6h18M8 6v12" stroke="currentColor" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round"/></svg>垃圾邮箱</button>
        <button class="nav-btn" data-zone="inbox" aria-pressed="false"><svg viewBox="0 0 24 24" width="20" height="20" fill="none"><path d="M3 7a1 1 0 0 1 1-1h16a1 1 0 0 1 1 1v9a1 1 0 0 1-1 1H4a1 1 0 0 1-1-1V7z" stroke="currentColor" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round"/></svg>收件邮箱</button>
        <button class="nav-btn" data-zone="main" aria-pressed="false"><svg viewBox="0 0 24 24" width="20" height="20" fill="none"><rect x="3" y="3" width="18" height="18" rx="3" stroke="currentColor" stroke-width="1.2"/><path d="M8 9h8M8 13h8" stroke="currentColor" stroke-width="1.2" stroke-linecap="round"/></svg>主页面</button>
      </nav>
    </aside>

    <main class="main">
      <div class="header">
        <div class="page-title">收件邮箱</div>
        <div style="display:flex;gap:8px;align-items:center">
          <button class="btn" id="composeBtn">写邮件</button>
        </div>
      </div>

      <section id="inbox" class="zone">
        <div class="card">
          <div style="display:flex;align-items:center;justify-content:space-between">
            <div><strong>收件邮箱</strong> <span class="muted">— 3 封新邮件</span></div>
            <div class="muted">刚刚更新</div>
          </div>

          <div class="inbox-split" style="margin-top:12px">
            <div class="inbox-list card" style="padding:12px;">
              <div class="emails" role="list">
                <div class="email" tabindex="0" role="listitem" data-from="歌者" data-subject="标题 请你帮我寻找我祖宗的宝藏" data-body="亲爱的朋友，<br>我是来自2135年的自由职业者。事情发展得太快了。昨天, 我的全部积蓄被一群狡猾的宇宙海盗骗走了，他们的飞船在离地球轨道 42 公里的地方消失无踪。就在我几乎绝望的时候，我无意间在老房子的砖缝里发现了一张陈旧的纸条。<br>纸条上写着：“这里埋藏着你2027年失踪祖宗的宝藏。”<br>更令人震惊的是，纸条下面还有一个古老的网址，看起来是指向某种加密页面。但在我们那个时代，110 年后的技术已无法解析如此陈旧的网络结构。我们的数据库不再识别这种文字编码<br>我有理由相信，这就是我家族的秘密遗产——足以让我重建一切的财富！<br>我正在准备启动探索任务。如果你愿意加入我，一起破解这条宝藏线索，请尽快回复这封邮件，因为我相信你是唯一可以帮助我的人。<br>歌者" data-score="100" data-sendyear="2135" data-replies='[{"author":"A6C2","body":"唉，听到你那样我挺难过的。听起来很有趣！我很乐意帮忙。你需要我做些什么？就是报酬嘛。","time":"2025"},{"author":"歌者","body":"没问题，只要你帮我找出宝藏埋藏在哪里，你想要什么都可以.","time":"2135"},{"author":"A6C2","body":"好的我要2025年11月第一次649开奖号码，听说奖池会积累到5300万。","time":"2025"},{"author":"歌者","body":"没问题！我这正好有一本《历史120年彩票中奖号码》。我先把网址给你，这个是<fai>链接|https://treasurenumber4.a6c2.top/math.html</fai>，剩下的事情就拜托啦。谢谢你的支持，朋友！","time":"2135"}]' >
                  <div class="avatar">歌</div>
                  <div class="meta">
                    <div style="display:flex;align-items:center">
                      <div class="from">歌者</div>
                    </div>
                    <div class="subject">标题 请你帮我寻找我祖宗的宝藏</div>
                    <div class="muted" style="font-size:13px">亲爱的朋友,事情发展得太快了。昨天, 我的全部</div>
                  </div>
                </div>

                <div class="email" tabindex="0" role="listitem" data-from="八十岁老太太自学爬树" data-subject="标题 帮忙寻找小猫" data-body="我家小猫不见了，是不是顺着网线爬到你那里了" data-score="75" data-sendyear="2096" data-replies='[]'>
                  <div class="avatar">八</div>
                  <div class="meta">
                    <div style="display:flex;align-items:center">
                      <div class="from">八十岁老太太自学爬树</div>
                    </div>
                    <div class="subject">标题 帮忙寻找小猫</div>
                    <div class="muted" style="font-size:13px">我家小猫不见了，是不是顺着网线爬到你那里了</div>
                  </div>
                </div>

                <div class="email" tabindex="0" role="listitem" data-from="啥都没有超市" data-subject="标题 啥都有超市货单已更新" data-body="亲爱的顾客，您好！啥都有超市货单已全面更新，本期上新了多种商品，包括日常用品、日常信息以及高级商品等，欢迎您前来选购！先到先得！感谢您一直以来的支持与信任！祝您购物愉快～" data-score="90" data-sendyear="2114" data-replies='[{"author":"A6C2","body":"有2026年649彩球中奖号码大全吗?","time":"2025"},{"author":"啥都没有超市","body":"不好意思，没有。","time":"2114"},{"author":"A6C2","body":"有防脱发洗发水吗吗？","time":"2025"},{"author":"啥都没有超市","body":"没有，我秃头。","time":"2114"},{"author":"A6C2","body":"你还叫啥都有超市，我看你叫啥都没有超市得了。","time":"2025"},{"author":"啥都没有超市","body":"亲爱的顾客，您好！本店已更名啥都没有超市！我们的超市货单已全面更新，本期上新了多种商品，包括日常用品、日常信息以及高级商品等，欢迎您前来选购！先到先得！感谢您一直以来的支持与信任！祝您购物愉快～。","time":"2114"},{"author":"A6C2","body":"。","time":"2025"}]'>
                  <div class="avatar">啥</div>
                  <div class="meta">
                    <div style="display:flex;align-items:center">
                      <div class="from">啥都没有超市</div>
                    </div>
                    <div class="subject">标题 啥都有超市货单已更新</div>
                    <div class="muted" style="font-size:13px">亲爱的顾客，您好！我们的超市货单已全面更</div>
                  </div>
                </div>

              </div>
            </div>

            <div class="inbox-detail card" aria-live="polite">
              <div class="email-detail-default">
                <div>
                  <div style="font-weight:700;font-size:16px" class="detail-from">歌者</div>
                  <div class="detail-subject">标题 请帮我找到我的祖宗的宝藏</div>
                  <div style="margin-top:8px">
                    <div class="muted detail-sendyear">发送年份: <span class="sendyear-value">2135</span></div>
                  </div>
                </div>

                <div class="conversation" aria-live="polite"></div>

                <!-- Safety score badge (positioned bottom-right of this card) -->
                <div class="safety-score" aria-hidden="true">
                  <div class="label">AI评估安全分数</div>
                  <div class="score-number">--</div>
                </div>
              </div>
            </div>

          </div>
        </div>
      </section>

      <section id="junk" class="zone">
        <div class="card">
          <div style="display:flex;align-items:center;justify-content:space-between">
            <div><strong>垃圾邮件</strong> <span class="muted">— 2 封邮件</span></div>
            <div class="muted">已扫描</div>
          </div>

          <div class="inbox-split" style="margin-top:12px">
            <div class="inbox-list card" style="padding:12px;">
              <div class="emails" role="list">
                <div class="email" tabindex="0" role="listitem" data-from="宇宙海盗" data-subject="标题 求救" data-body="这里是宇宙海盗。<br>我们截获了来自银河中央数据库的一段禁忌资料：AI 正在秘密接管人类文明核心。<br>在过去 30 年中，已有 72% 的人类决策由伪装成人类的自治智能体完成。<br>官方封锁了一切证据，但我们掌握了真相。<br>为了阻止全面觉醒，我们需要建立反AI同盟基金。<br>这笔资金将用于制造量子干扰器，重启自由的人类意识。" data-score="15" data-sendyear="2136">
                  <div class="avatar">宇</div>
                  <div class="meta"><div class="from">宇宙海盗</div><div class="subject">标题 求救</div><div class="muted">这里是宇宙海盗。我们</div></div>
                </div>

                <div class="email" tabindex="0" role="listitem" data-from="二姨的三舅舅的妹妹" data-subject="标题 欠教训了" data-body="好小子，又是你指示我外甥摁我家门铃，以后见你一次打你一次" data-score="30" data-sendyear="2076">
                  <div class="avatar">二</div>
                  <div class="meta"><div class="from">二姨的三舅舅的妹妹</div><div class="subject">标题 欠教训了</div><div class="muted">好小子，又是你指示我外甥摁我家门铃</div></div>
                </div>
              </div>
            </div>

            <div class="inbox-detail card" aria-live="polite">
              <div class="email-detail-default">
                <div>
                  <div style="font-weight:700;font-size:16px" class="detail-from">Spam Corp</div>
                  <div class="detail-subject">标题 求救</div>
                  <div style="margin-top:8px">
                    <div class="muted detail-sendyear">发送年份: <span class="sendyear-value">2021</span></div>
                  </div>
                </div>

                <div class="conversation" aria-live="polite"></div>

                <div class="safety-score" aria-hidden="true">
                  <div class="label">AI评估安全分数</div>
                  <div class="score-number">--</div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </section>

      <section id="sent" class="zone active">
        <div class="card">
          <div style="display:flex;align-items:center;justify-content:space-between">
            <div><strong>发送</strong> <span class="muted">— 1条新消息</span></div>
            <div class="muted">已发送邮件</div>
          </div>

          <div class="inbox-split" style="margin-top:12px">
            <div class="inbox-list card" style="padding:12px;">
              <div class="emails" role="list">
                <div class="email" tabindex="0" role="listitem" data-from="A6C2" data-subject="标题 Re: 我终于发现了这里" data-body="今年是2022年，我写给自己来证明今天我发现了这里！." data-score="100" data-sendyear="2022">
                  <div class="avatar">A</div>
                  <div class="meta"><div class="from">A6C2</div><div class="subject">标题 我终于发现了这里</div><div class="muted">今年是2022年，我写给自己来证明今天</div></div>
                </div>
              </div>
            </div>

            <div class="inbox-detail card" aria-live="polite">
              <div class="email-detail-default">
                <div>
                  <div style="font-weight:700;font-size:16px" class="detail-from">A6C2</div>
                  <div class="detail-subject">标题 我终于发现了这里</div>
                  <div style="margin-top:8px">
                    <div class="muted detail-sendyear">接收人所在年份: <span class="sendyear-value">2022</span></div>
                  </div>
                </div>

                <div class="conversation" aria-live="polite"></div>

                <div class="safety-score" aria-hidden="true">
                  <div class="label">AI评估安全分数</div>
                  <div class="score-number">--</div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </section>

      <section id="main" class="zone">
        <div class="card">
          <strong>Welcome to Chronomail</strong>
          <p class="muted" style="margin-top:8px">User summary and quick info.</p>

          <div class="info-list">
            <div class="info-row">
              <div class="info-label">用户名</div>
              <div id="mainUsername" class="info-value">A6C2</div>
            </div>

            <div class="info-row">
              <div class="info-label">年份</div>
              <div id="mainYear" class="info-value">2025</div>
            </div>

            <div class="info-row">
              <div class="info-label">签名</div>
              <div id="mainSignature" class="info-value">He said one day you will leave this world behind, so live a life you will remember!</div>
            </div>

            <div class="info-row">
              <div class="info-label">密码</div>
              <div id="mainPassword" class="info-value">TrueStoriesTim</div>
            </div>

            <div class="info-row">
              <div class="info-label">开始年份</div>
              <div id="mainStartTime" class="info-value">2022</div>
            </div>
          </div>
        </div>
      </section>

    </main>
  </div>

  <script>
    // Simple page switching
    (function(){
      const navBtns = document.querySelectorAll('.nav-btn');
      const zones = document.querySelectorAll('.zone');
      const titleEl = document.querySelector('.page-title');

      function setActive(zoneId, clickedBtn){
        zones.forEach(z => z.classList.toggle('active', z.id===zoneId));
        navBtns.forEach(b => {
          const active = b.dataset.zone === zoneId;
          b.classList.toggle('active', active);
          b.setAttribute('aria-pressed', active ? 'true' : 'false');
        });
        // simple animation for title
        titleEl.style.opacity = 0; setTimeout(()=>{ titleEl.textContent = clickedBtn.textContent.trim(); titleEl.style.opacity=1; },150);
        // wire the newly activated zone's email list
        const zoneEl = document.getElementById(zoneId);
        if(zoneEl) wireZone(zoneEl);
      }

      navBtns.forEach(btn => {
        btn.addEventListener('click', ()=> setActive(btn.dataset.zone, btn));
        btn.addEventListener('keydown', (e)=>{ if(e.key==='Enter' || e.key===' ') { e.preventDefault(); btn.click(); } });
      });

      // Email list selection: show details in the right pane for any zone element
      function wireZone(zoneEl){
        if(!zoneEl) return;
        // avoid wiring twice
        if(zoneEl.dataset.wired === 'true') return;
        const emails = zoneEl.querySelectorAll('.email');
  const detailFrom = zoneEl.querySelector('.detail-from');
  const detailSubject = zoneEl.querySelector('.detail-subject');
  const convContainer = zoneEl.querySelector('.conversation');
  const detailSendYear = zoneEl.querySelector('.detail-sendyear .sendyear-value');
        const badge = zoneEl.querySelector('.safety-score');

        function updateSafetyFor(el){
          if(!badge) return;
          const scoreEl = badge.querySelector('.score-number');
          let score = typeof el.dataset.score !== 'undefined' ? Number(el.dataset.score) : 0;
          if(Number.isNaN(score)) score = 0;
          score = Math.max(0, Math.min(100, Math.round(score)));
          if(scoreEl) scoreEl.textContent = score;
          badge.classList.remove('score-green','score-yellow','score-red');
          if(score >= 70) badge.classList.add('score-green');
          else if(score >= 40) badge.classList.add('score-yellow');
          else badge.classList.add('score-red');
        }

        // small helper to avoid injecting raw HTML
        function escapeHtml(s){
          if(!s) return '';
          return String(s).replace(/[&<>"']/g, function(m){ return {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;"}[m]; });
        }

        // Create a DocumentFragment from a raw string where <br> (and variants) and newlines
        // are treated as line breaks. This avoids using innerHTML and prevents XSS.
        // Additionally, support a custom tag <fai>...</fai> which will be rendered as a link.
        // Inside <fai> you can use either:
        //   <fai>https://example.com</fai>  => link text will be the URL
        //   <fai>显示文本|https://example.com</fai> => link text before '|' and URL after '|'
        function ensureUrlProtocol(u){
          if(!u) return u;
          // if already has scheme like http:// or https:// or mailto:, keep it
          if(/^[a-zA-Z][a-zA-Z0-9+.-]*:\/\//.test(u)) return u;
          return 'http://' + u;
        }

        function fragmentWithBreaks(raw){
          const frag = document.createDocumentFragment();
          if(!raw) return frag;
          // Split on <br>, <br/>, </br> or any newline sequence
          const parts = raw.split(/<\s*br\s*\/?\s*>|<\s*\/br\s*>|\r\n|\r|\n/gi);
          // accept either <kai> or <fai> as link tags
          const tagRegex = /<\s*(?:k|fai)\s*>([\s\S]*?)<\s*\/\s*(?:k|fai)\s*>/i;
          parts.forEach((part, i) => {
            let remaining = part;
            while(true){
              const m = remaining.match(tagRegex);
              if(!m) break;
              const idx = m.index;
              const before = remaining.slice(0, idx);
              if(before) frag.appendChild(document.createTextNode(before));
              const inner = (m[1] || '').trim();
              let linkText = inner;
              let url = inner;
              const pipePos = inner.indexOf('|');
              if(pipePos !== -1){
                linkText = inner.slice(0, pipePos).trim();
                url = inner.slice(pipePos+1).trim();
              }
              const a = document.createElement('a');
              a.href = ensureUrlProtocol(url || linkText);
              a.target = '_blank';
              a.rel = 'noopener noreferrer';
              a.textContent = linkText || url;
              frag.appendChild(a);
              remaining = remaining.slice(idx + m[0].length);
            }
            if(remaining) frag.appendChild(document.createTextNode(remaining));
            if(i < parts.length - 1) frag.appendChild(document.createElement('br'));
          });
          return frag;
        }

        function showDetail(el){
          const from = el.dataset.from || '';
          const subject = el.dataset.subject || '';
          const body = el.dataset.body || '';
          if(detailFrom) detailFrom.textContent = from;
          if(detailSubject) detailSubject.textContent = subject;
          if(detailSendYear){
            const sendYear = typeof el.dataset.sendyear !== 'undefined' ? el.dataset.sendyear : '';
            detailSendYear.textContent = sendYear;
          }

          // build conversation thread: original + up to 3 previous replies
          if(convContainer){
            convContainer.innerHTML = '';
            // read structured replies from data-replies (JSON) if provided.
            // If no data-replies attribute exists, generate demo replies for demo purposes.
            let replies = null;
            if('replies' in el.dataset){
              try{ replies = JSON.parse(el.dataset.replies) || []; }catch(e){ replies = []; }
            }
            // If replies is null => no data provided; generate demo replies
            if(replies === null){
              const baseYear = Number(el.dataset.sendyear) || new Date().getFullYear();
              const other = (from === 'A6C2') ? 'Recipient' : 'A6C2';
              replies = [
                {author: other, body: 'Thanks — I saw this and will follow up shortly.', time: String(baseYear)},
                {author: from, body: 'Please review the attached notes and confirm.', time: String(baseYear-1)},
                {author: other, body: 'Confirmed. Looks good from my side.', time: String(baseYear-2)}
              ];
            }

            // original message first
            const original = {author: from, body: body, time: detailSendYear ? detailSendYear.textContent : ''};
            // include original plus all provided replies (cap to 20 for safety)
            let items = [original].concat(replies.slice(0,20));

            // For Junk and Sent zones, only show the original message (no replies)
            const parentZone = el.closest('.zone');
            const zoneId = parentZone ? parentZone.id : '';
            if(zoneId === 'junk' || zoneId === 'sent'){
              items = [original];
            }

            items.forEach((it, idx)=>{
              const item = document.createElement('div'); item.className = 'conv-item';
              const header = document.createElement('div'); header.className = 'conv-header';
              const left = document.createElement('div'); left.innerHTML = '<strong>'+escapeHtml(it.author)+'</strong> <span class="muted conv-time">'+escapeHtml(it.time)+'</span>';
              header.appendChild(left);

              // Create an expand/collapse toggle when there are multiple items (replies exist),
              // or when we're in the Junk/Sent zones — the user wants a toggle there as well.
              if(items.length >= 1){
                const toggle = document.createElement('button'); toggle.className = 'conv-toggle'; toggle.setAttribute('aria-expanded','false'); toggle.textContent = '▾';
                header.appendChild(toggle);
              }

              const bodyEl = document.createElement('div'); bodyEl.className = 'conv-body';
              // Safely render the body by building DOM nodes (text + <br>) without using innerHTML.
              bodyEl.appendChild(fragmentWithBreaks(it.body || ''));
              item.appendChild(header); item.appendChild(bodyEl);
              convContainer.appendChild(item);

              const toggleBtn = item.querySelector('.conv-toggle');
              if(toggleBtn){
                toggleBtn.addEventListener('click', ()=>{
                  const expanded = item.classList.toggle('expanded');
                  toggleBtn.setAttribute('aria-expanded', expanded ? 'true' : 'false');
                  toggleBtn.textContent = expanded ? '▴' : '▾';
                });
              }
            });

            // clicking the recipient (detailFrom) will expand only the newest reply (last reply in items)
            if(detailFrom){
              detailFrom.style.cursor = 'pointer';
              detailFrom.onclick = ()=>{
                const all = convContainer.querySelectorAll('.conv-item');
                all.forEach(n=>{ n.classList.remove('expanded'); const b = n.querySelector('.conv-toggle'); if(b) { b.setAttribute('aria-expanded','false'); b.textContent = '▾'; } });
                const newest = all[all.length-1];
                if(newest){ newest.classList.add('expanded'); const btn = newest.querySelector('.conv-toggle'); if(btn){ btn.setAttribute('aria-expanded','true'); btn.textContent = '▴'; } }
              };
            }
          }
          emails.forEach(e=> e.classList.remove('selected'));
          el.classList.add('selected');
          updateSafetyFor(el);
        }

        emails.forEach((el, idx)=>{
          el.addEventListener('click', ()=> showDetail(el));
          el.addEventListener('keydown', (e)=>{ if(e.key==='Enter' || e.key===' '){ e.preventDefault(); showDetail(el); } });
        });

        // select first email by default
        if(emails.length) showDetail(emails[0]);
        zoneEl.dataset.wired = 'true';
      }

      // wire initial active zone
      const activeZone = document.querySelector('.zone.active');
      if(activeZone) wireZone(activeZone);

      // Compose button shows a short message (author didn't implement sending)
      const compose = document.getElementById('composeBtn');
      compose.addEventListener('click', ()=>{
        alert('作者懒得开发了，知道这里是写邮件的地方就好。');
      });

    })();
  </script>
</body>
</html>
